name: dq-repair-incremental
on:
  schedule:
    - cron: "20 3 */2 * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - run: |
          python -m pip install --upgrade pip
          pip install "cassandra-driver==3.29.0" requests python-dotenv tzdata

      - run: echo "PYTHONPATH=." >> "$GITHUB_ENV"

      - name: Rehydrate secure-connect.zip
        shell: bash
        env:
          SECURE_CONNECT_ZIP_B64: ${{ secrets.ASTRA_BUNDLE_BASE64 }}
        run: |
          set -euo pipefail
          base64 --decode --ignore-garbage <<< "$SECURE_CONNECT_ZIP_B64" > secure-connect.zip

      - name: Run incremental repair
        env:
          ASTRA_BUNDLE_PATH: secure-connect.zip
          ASTRA_TOKEN: ${{ secrets.ASTRA_TOKEN }}
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          # If unset/empty, default to "pro"
          COINGECKO_API_TIER: ${{ secrets.COINGECKO_API_TIER || 'pro' }}
          FULL_MODE: "0"
        run: python prices/FF_gck_dq_repair_timeseries.py
