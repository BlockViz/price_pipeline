name: dq-repair-incremental
on:
  schedule:
    - cron: "20 3 */2 * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          {
            python-version: "3.11",
            cache: "pip",
            cache-dependency-path: "requirements.txt",
          }
      - run: |
          python -m pip install --upgrade pip
          pip install "cassandra-driver==3.29.0" requests python-dotenv tzdata
      - run: echo "PYTHONPATH=." >> "$GITHUB_ENV"
      - run: echo "${{ secrets.ASTRA_BUNDLE_BASE64 }}" | base64 -d > secure-connect.zip
      - name: Run incremental repair
        env:
          ASTRA_BUNDLE_PATH: secure-connect.zip
          ASTRA_TOKEN: ${{ secrets.ASTRA_TOKEN }}
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          COINGECKO_API_TIER: ${{ secrets.COINGECKO_API_TIER != '' && secrets.COINGECKO_API_TIER || 'pro' }}
          FULL_MODE: "0"
        run: python prices/FF_gck_dq_repair_timeseries.py
