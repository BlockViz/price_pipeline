name: dq-repair

on:
  schedule:
    - cron: "20 3 * * *"   # 03:20 UTC daily
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: "Dry run (no writes) 0/1"
        required: false
        default: "0"
      VERBOSE:
        description: "Verbose logs 0/1"
        required: false
        default: "0"
      BACKFILL_DAILY_FROM_API:
        description: "Use API to fill missing daily 0/1"
        required: false
        default: "1"
      SEED_15M_FROM_DAILY:
        description: "Seed synthetic 15m from daily 0/1 (usually keep OFF)"
        required: false
        default: "0"
      TOP_N_DQ:
        description: "Max coins to scan (blank=default)"
        required: false
        default: ""
      DQ_MAX_API_COINS_PER_RUN:
        description: "API backfills per run (cap)"
        required: false
        default: "20"

permissions:
  contents: read

concurrency:
  group: dq-repair
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    env:
      TZ: UTC
      PYTHONUNBUFFERED: "1"   # stream print() immediately
      PYTHONUTF8: "1"
      # Quieter logs; remove if you want to see deprecations
      PYTHONWARNINGS: "ignore::DeprecationWarning"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write Astra secure connect bundle
        run: |
          set -euo pipefail
          echo "${{ secrets.ASTRA_BUNDLE_BASE64 }}" | base64 -d > secure-connect.zip
          test -s secure-connect.zip || { echo "secure-connect.zip missing/empty"; exit 1; }
          ls -lh secure-connect.zip

      - name: Data Quality & Repair
        timeout-minutes: 25
        env:
          ASTRA_BUNDLE_PATH: secure-connect.zip
          ASTRA_TOKEN: ${{ secrets.ASTRA_TOKEN }}
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}

          # Target tables (daily was "renamed")
          DAILY_TABLE: "candles_daily_contin"

          # Windows & scope
          TOP_N_DQ: ${{ github.event.inputs.TOP_N_DQ != '' && github.event.inputs.TOP_N_DQ || '110' }}
          DQ_MAX_COINS: "110"
          DQ_WINDOW_15M_DAYS: "7"
          DQ_WINDOW_DAILY_DAYS: "365"

          # Behavior toggles
          FIX_DAILY_FROM_15M: "1"
          BACKFILL_DAILY_FROM_API: ${{ github.event.inputs.BACKFILL_DAILY_FROM_API || '1' }}
          SEED_15M_FROM_DAILY: ${{ github.event.inputs.SEED_15M_FROM_DAILY || '0' }}
          DQ_DRY_RUN: ${{ github.event.inputs.DRY_RUN || '0' }}

          # API cap per run
          DQ_MAX_API_COINS_PER_RUN: ${{ github.event.inputs.DQ_MAX_API_COINS_PER_RUN || '20' }}

          # Tuning
          DQ_REQUEST_TIMEOUT_SEC: "30"
          DQ_CONNECT_TIMEOUT_SEC: "15"
          DQ_FETCH_SIZE: "500"
          DQ_RETRIES: "3"
          DQ_BACKOFF_SEC: "4"
          DQ_PAUSE_PER_COIN: "0.2"

          # Logging
          DQ_LOG_EVERY: "10"
          DQ_VERBOSE: ${{ github.event.inputs.VERBOSE || '0' }}
          DQ_TIME_API: "1"
        run: |
          set -euo pipefail
          python dq_repair_timeseries.py
