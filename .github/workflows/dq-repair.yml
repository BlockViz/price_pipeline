name: dq-repair

on:
  schedule:
    - cron: "10 2 * * *" # 02:10 UTC → daily local interpolation (no CoinGecko)
    - cron: "20 3 */4 * *" # 03:20 UTC every 4 days → full repair (top 20, with CoinGecko)
  workflow_dispatch:
    inputs:
      mode:
        description: "Select run mode"
        type: choice
        required: false
        default: daily
        options: [daily, full]

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - run: |
          python -m pip install --upgrade pip
          pip install "cassandra-driver==3.29.0" requests python-dotenv tzdata

      - run: echo "PYTHONPATH=." >> "$GITHUB_ENV"

      # ───────────────── Astra: secure bundle ─────────────────
      - name: Rehydrate secure-connect.zip
        shell: bash
        env:
          SECURE_CONNECT_ZIP_B64: ${{ secrets.ASTRA_BUNDLE_BASE64 }}
        run: |
          set -euo pipefail
          base64 --decode --ignore-garbage <<< "$SECURE_CONNECT_ZIP_B64" > secure-connect.zip
          echo "ASTRA_BUNDLE_PATH=$PWD/secure-connect.zip" >> "$GITHUB_ENV"
          echo "ASTRA_SECURE_BUNDLE=$PWD/secure-connect.zip" >> "$GITHUB_ENV"

      # ───────────────── Astra: token (supports plaintext or base64) ─────────────────
      - name: Export Astra token
        shell: bash
        env:
          ASTRA_TOKEN_PLAINTEXT: ${{ secrets.ASTRA_TOKEN }}
          ASTRA_TOKEN_B64: ${{ secrets.ASTRA_TOKEN_B64 }}
        run: |
          set -euo pipefail
          if [ -n "${ASTRA_TOKEN_PLAINTEXT}" ]; then
            echo "ASTRA_TOKEN=${ASTRA_TOKEN_PLAINTEXT}" >> "$GITHUB_ENV"
            echo "Using plaintext ASTRA_TOKEN secret"
          elif [ -n "${ASTRA_TOKEN_B64}" ]; then
            TOK=$(echo "${ASTRA_TOKEN_B64}" | base64 -d)
            echo "ASTRA_TOKEN=${TOK}" >> "$GITHUB_ENV"
            echo "Decoded ASTRA_TOKEN from ASTRA_TOKEN_B64"
          else
            echo "ERROR: Neither ASTRA_TOKEN nor ASTRA_TOKEN_B64 is set as a secret." >&2
            exit 1
          fi

      # ─────────── Decide which run to perform (daily vs full) ───────────
      - name: Compute RUN_KIND (daily vs full)
        id: when
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          MODE_INPUT: ${{ github.event.inputs.mode }}
          CRON_EXPR: ${{ github.event.schedule }}
        run: |
          set -euo pipefail
          if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ -n "${MODE_INPUT:-}" ]; then
            case "$MODE_INPUT" in
              full)
                echo "RUN_KIND=FULL_REPAIR" >> "$GITHUB_ENV"
                echo "mode set from input: full"
                exit 0
                ;;
              daily|*)
                echo "RUN_KIND=DAILY_INTERP" >> "$GITHUB_ENV"
                echo "mode set from input: daily"
                exit 0
                ;;
            esac
          fi

          if [ "$EVENT_NAME" = "schedule" ]; then
            if [ "$CRON_EXPR" = "10 2 * * *" ]; then
              echo "RUN_KIND=DAILY_INTERP" >> "$GITHUB_ENV"
              echo "RUN_KIND set from schedule: daily interpolation (02:10 UTC)"
            elif [ "$CRON_EXPR" = "20 3 */4 * *" ]; then
              echo "RUN_KIND=FULL_REPAIR" >> "$GITHUB_ENV"
              echo "RUN_KIND set from schedule: full repair (every 4 days, 03:20 UTC)"
            else
              echo "RUN_KIND=DAILY_INTERP" >> "$GITHUB_ENV"
              echo "RUN_KIND defaulted to daily interpolation"
            fi
            exit 0
          fi

          echo "RUN_KIND=DAILY_INTERP" >> "$GITHUB_ENV"
          echo "RUN_KIND defaulted to daily interpolation"

      # ─────────── Availability: intraday coverage (10m/hourly) ───────────
      - name: Update intraday coverage (10m/hourly)
        env:
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          REQUEST_TIMEOUT_SEC: "30"
          LOG_HEARTBEAT_SEC: "20"
          AVAIL_RUN_DAILY: "0"
          AVAIL_RUN_INTRADAY: "1"
          IDS_SOURCE: "live"
        run: |
          python prices/FF_gck_coin_data_availability.py

      # ─────────── Availability: daily coverage (ranges + summary) ───────────
      - name: Update daily coverage (ranges + summary)
        env:
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          REQUEST_TIMEOUT_SEC: "30"
          LOG_HEARTBEAT_SEC: "20"
          AVAIL_RUN_DAILY: "1"
          AVAIL_RUN_INTRADAY: "0"
          IDS_SOURCE: "daily"
        run: |
          python prices/FF_gck_coin_data_availability.py

      # -- wait 60 seconds so coverage writes are visible
      - name: Wait for coverage writes to become visible
        run: sleep 60

      # ─────────── (1) DAILY: local interpolation-only (no CoinGecko) ───────────
      - name: Daily interpolation repair (local only, no CoinGecko)
        if: env.RUN_KIND == 'DAILY_INTERP'
        env:
          ASTRA_TOKEN: ${{ env.ASTRA_TOKEN }}
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          ASTRA_BUNDLE_PATH: ${{ env.ASTRA_BUNDLE_PATH }}
          ASTRA_SECURE_BUNDLE: ${{ env.ASTRA_SECURE_BUNDLE }}

          # Nightly-style window → look back further than just yesterday
          DQ_MODE: "NIGHTLY"
          DQ_WINDOW_DAILY_DAYS: "30" # <-- fix: repair last 30 days daily
          DQ_WINDOW_10M_DAYS: "7"
          DQ_WINDOW_HOURLY_DAYS: "30" # still irrelevant here (no hourly repair)
          RECOMPUTE_MONTHLY: "1"

          # Daily from 10m ON, no CoinGecko
          FIX_DAILY_FROM_10M: "1"
          BACKFILL_DAILY_FROM_API: "0" # disable API
          SEED_10M_FROM_DAILY: "0" # keep synthetic 10m off unless you want it
          FILL_HOURLY: "1" # enable hourly interpolation-only in the daily pass
          FILL_HOURLY_BADSCAN: "0"
          FILL_HOURLY_FROM_API: "0" # keep API off for daily; use interp/carry from 10m
          INTERPOLATE_IF_API_MISS: "1" # allow interpolation/carry when API is disabled

          # Aggregates: incremental, daily only
          FULL_MODE: "0" # incremental recompute
          TRUNCATE_AGGREGATES_IN_FULL: "0"
          RECOMPUTE_MCAP_DAILY: "1"
          RECOMPUTE_MCAP_HOURLY: "1" # recompute hourly aggregates for the repaired hours
          RECOMPUTE_MCAP_10M: "0"

          # Let script defaults handle universe (top_N + all daily IDs)
        run: |
          python prices/GG_gck_dq_repair_timeseries.py

      # ─────────── (2) FULL: API-based repair for top 20 (hourly + daily, no 10m) ───────────
      - name: Full repair (top 20, CoinGecko, hourly+daily only)
        if: env.RUN_KIND == 'FULL_REPAIR'
        env:
          ASTRA_TOKEN: ${{ env.ASTRA_TOKEN }}
          ASTRA_KEYSPACE: ${{ secrets.ASTRA_KEYSPACE }}
          ASTRA_BUNDLE_PATH: ${{ env.ASTRA_BUNDLE_PATH }}
          ASTRA_SECURE_BUNDLE: ${{ env.ASTRA_SECURE_BUNDLE }}

          # Use INTRADAY mode so universe is restricted to live top-N
          DQ_MODE: "INTRADAY"
          TOP_N_DQ: "20" # top 20 from live
          DQ_MAX_COINS: "20" # hard cap at 20
          INCLUDE_ALL_DAILY_IDS: "0" # no long tail
          INTRADAY_TOP_N: "20"
          INCLUDE_UNRANKED_INTRADAY: "0"

          # Windows: how far back to repair
          DQ_WINDOW_10M_DAYS: "7" # used only for FIX_DAILY_FROM_10M
          DQ_WINDOW_HOURLY_DAYS: "30" # repair last 30d hourly
          DQ_WINDOW_DAILY_DAYS: "365" # repair last 365d daily
          RECOMPUTE_MONTHLY: "1"

          # Daily + hourly repair using CoinGecko
          FIX_DAILY_FROM_10M: "1" # use existing 10m to build daily when available
          BACKFILL_DAILY_FROM_API: "1" # fetch real daily from CoinGecko
          DAILY_API_REQ_BUDGET: "150"
          SEED_10M_FROM_DAILY: "0" # do NOT write synthetic 10m (we only care about hourly+daily)
          FILL_HOURLY: "1" # repair hourly
          FILL_HOURLY_BADSCAN: "1"
          FILL_HOURLY_FROM_API: "1" # use CoinGecko hourly via market_chart/range
          INTERPOLATE_IF_API_MISS: "1" # interpolate around API data where needed

          # Aggregates: full recompute over windows, hourly+daily only
          FULL_MODE: "1"
          TRUNCATE_AGGREGATES_IN_FULL: "1"
          RECOMPUTE_MCAP_10M: "0" # leave 10m aggregates alone
          RECOMPUTE_MCAP_HOURLY: "1"
          RECOMPUTE_MCAP_DAILY: "1"

          # CoinGecko
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          COINGECKO_API_TIER: ${{ secrets.COINGECKO_API_TIER || 'pro' }}
        run: |
          python prices/GG_gck_dq_repair_timeseries.py
